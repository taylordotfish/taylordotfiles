#!/bin/sh
# Copyright (C) 2024 taylor.fish <contact@taylor.fish>
# License: GNU GPL version 3 or later
set -eu

. ~/scripts/monitor-utils.sh

for arg in "$@"; do
    case "$arg" in
        --overwrite)
            overwrite=1
            ;;
        --)
            break
            ;;
        --*)
            ;;
        -*o*)
            overwrite=1
            ;;
    esac
done

parse() {
    index=$1
    width=$2
    height=$3
    posx=$4
    posy=$5
}

set -f
OLDIFS=$IFS
fullwidth=0
fullheight=0
IFS='
'
for line in $(monitors); do
    width=$(printf '%s\n' "$line" | cut -f2)
    height=$(printf '%s\n' "$line" | cut -f3)
    posx=$(printf '%s\n' "$line" | cut -f4)
    posy=$(printf '%s\n' "$line" | cut -f5)
    right=$((posx+width))
    bottom=$((posy+height))
    [ "$right" -gt "$fullwidth" ] && fullwidth=$right
    [ "$bottom" -gt "$fullheight" ] && fullheight=$bottom
done

im_args=
for line in $(monitors); do
    width=$(printf '%s\n' "$line" | cut -f2)
    height=$(printf '%s\n' "$line" | cut -f3)
    posx=$(printf '%s\n' "$line" | cut -f4)
    posy=$(printf '%s\n' "$line" | cut -f5)
    im_args="$im_args -draw 'rectangle $posx,0 $((posx+width)),$posy'"
    im_args="$im_args -draw 'rectangle $posx,$((posy+height))"
    im_args="$im_args $((posx+width)),$fullheight'"
done

set +f
IFS=$OLDIFS
scrot=$(PATH=/usr/bin:/usr/local/bin which scrot)

tmp=$(mktemp -d)
trap 'rm -r "$tmp"' EXIT
(cd "$tmp" && "$scrot" "$@")

fullsize="$fullwidth"x"$fullheight"
for img in "$tmp"/*.png; do
    if [ "$(identify -format '%wx%h' "$img")" = "$fullsize" ]; then
        eval 'mogrify -fill white '"$im_args"' -alpha off "$img"'
    fi
    mv_args=
    [ -z "${overwrite-}" ] && mv_args="$mv_args -n"
    mv $mv_args "$img" .
    i=0
    while [ -f "$img" ]; do
        name=$(basename "$img")
        mv -n "$img" "${name%.png}_$(printf '%03d' "$i").png"
        i=$((i+1))
    done
done
