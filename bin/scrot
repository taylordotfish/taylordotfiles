#!/bin/sh
# Copyright (C) 2024 taylor.fish <contact@taylor.fish>
# License: GNU GPL version 3 or later
set -euf

fullwidth=0
fullheight=0
IFS='
'
for line in $(~/scripts/monitor-utils.sh monitors); do
    width=$(printf '%s\n' "$line" | cut -f2)
    height=$(printf '%s\n' "$line" | cut -f3)
    posx=$(printf '%s\n' "$line" | cut -f4)
    posy=$(printf '%s\n' "$line" | cut -f5)
    right=$((posx+width))
    bottom=$((posy+height))
    [ "$right" -gt "$fullwidth" ] && fullwidth=$right
    [ "$bottom" -gt "$fullheight" ] && fullheight=$bottom
done

im_args=
for line in $(~/scripts/monitor-utils.sh monitors); do
    width=$(printf '%s\n' "$line" | cut -f2)
    height=$(printf '%s\n' "$line" | cut -f3)
    posx=$(printf '%s\n' "$line" | cut -f4)
    posy=$(printf '%s\n' "$line" | cut -f5)
    if [ "$posy" -gt 0 ]; then
        im_args="$im_args -draw 'rectangle $posx,0"
        im_args="$im_args $((posx+width-1)),$((posy-1))'"
    fi
    if [ "$((posy+height))" -lt "$fullheight" ]; then
        im_args="$im_args -draw 'rectangle $posx,$((posy+height))"
        im_args="$im_args $((posx+width-1)),$((fullheight-1))'"
    fi
done

fullsize="$fullwidth"x"$fullheight"
scrot=$(PATH=/usr/bin:/usr/local/bin which scrot)
"$scrot" -e "\
if [ \"\\\$(identify -format '%%wx%%h' '\$f')\" = \"$fullsize\" ]; then \
mogrify -fill white $im_args -alpha off '\$f'; fi" "$@"
